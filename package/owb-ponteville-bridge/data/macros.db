{"name":"Reload","permission":{"default":0,"HhnWBl4ct8mgv92y":3},"type":"script","sort":100001,"flags":{},"scope":"global","command":"function getAmmo(token, calibre) {\n    if (token && calibre) {\n      const hasAmmo = (i) => {\n        return (i.type == \"item\" &&  i.data.tags &&\n                (i.data.tags.find(t => t.title === \"cal\" && t.value === calibre) !== undefined)\n                );\n      }\n      return token.actor.data.items.find(f => hasAmmo(f));\n    }\n    return [];\n}\n\nasync function reloadAmmo(token, weapon_id) {\n    const weapon = token.actor.data.items.find(f => f._id === weapon_id);\n    let calibre = weapon.data.tags.filter(i => i.title === \"cal\");\n    calibre = calibre.length > 0 ? calibre[0].value : 0;\n    const ammo = getAmmo(token, calibre);\n    let messageContent;\n    if (ammo) {\n        ammo.data.quantity.value = Math.max(0,ammo.data.quantity.max);\n        await token.actor.updateEmbeddedEntity(\"OwnedItem\", {...ammo});\n        messageContent = `Reloaded ${weapon.name} with ${ammo.name}`;\n    } else {\n        messageContent = `You don't have any ammo for a ${weapon.name}`;\n    }\n    const chatData = {\n        user: game.user._id,\n        speaker: ChatMessage.getSpeaker(),\n        content: messageContent\n    };\n    ChatMessage.create(chatData, {});\n}\n\nif (token) {\n    let applyChanges = false;\n    let options = \"\"\n    token.actor.items.forEach(w => {\n    if (w.data.type === \"weapon\") {\n        options += `<option value=\"${w.id}\">${w.data.name}</option>\\n`;\n    }\n    });\n    new Dialog({\n    title: `Token Vision Configuration`,\n    content: `\n        <form>\n        <div class=\"form-group\">\n            <label>Reload Weapon:</label>\n            <select id=\"weapon\" name=\"weapon\">\n            <option value=\"none\">No Weapon</option>\n            ${options}\n            </select>\n        </div>\n        </form>\n        `,\n    buttons: {\n        yes: {\n        icon: \"<i class='fas fa-check'></i>\",\n        label: `Reload`,\n        callback: () => applyChanges = true\n        },\n        no: {\n        icon: \"<i class='fas fa-times'></i>\",\n        label: `Cancel`\n        },\n    },\n    default: \"yes\",\n    close: html => {\n        if (applyChanges) {\n            const weapon_id = html.find('[name=\"weapon\"]')[0].value || \"none\";\n            if (weapon_id !== \"none\") {\n                reloadAmmo(token, weapon_id);\n            }\n        }\n    }\n    }).render(true);\n} else {\n    ui.notifications.warn(`You must select a token first.`);\n}","author":"HhnWBl4ct8mgv92y","img":"icons/svg/target.svg","actorIds":[],"_id":"bBXdxQ6W7AH3lFe8"}
